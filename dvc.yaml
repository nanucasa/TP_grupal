stages:
  data_prep:
    cmd: python src\data_prep.py --input data\raw\telco_churn.csv --outdir 
      data\processed --seed 42 --test-size 0.2 --val-size 0.1
    deps:
    - data\raw\telco_churn.csv
    - src\data_prep.py
    outs:
    - data\processed

  feature_eng:
    cmd: python src\feature_eng.py --train-in data\processed\train.csv 
      --valid-in data\processed\valid.csv --test-in data\processed\test.csv 
      --train-out data\features\train_fe.csv --valid-out 
      data\features\valid_fe.csv --test-out data\features\test_fe.csv
    deps:
    - src\feature_eng.py
    - data\processed\train.csv
    - data\processed\valid.csv
    - data\processed\test.csv
    outs:
    - data\features\train_fe.csv
    - data\features\valid_fe.csv
    - data\features\test_fe.csv

  tune:
    cmd: python src\tune.py --train data\processed\train.csv --valid 
      data\processed\valid.csv --params params.yaml --best-out 
      artifacts\best_params.json --metrics-out metrics_tune.json
    deps:
    - data\processed\train.csv
    - data\processed\valid.csv
    - params.yaml
    - src\tune.py
    metrics:
    - artifacts\best_params.json:
        cache: false
    - metrics_tune.json:
        cache: false

  train:
    cmd: python src\train.py --train data\processed\train.csv --valid 
      data\processed\valid.csv --out-model models\model.joblib --metrics 
      metrics.json --best-params artifacts\best_params.json --params params.yaml
    deps:
    - artifacts\best_params.json
    - data\processed\train.csv
    - data\processed\valid.csv
    - src\train.py
    outs:
    - models\model.joblib
    metrics:
    - metrics.json:
        cache: false
    params:
    - train.C
    - train.max_iter
    - train.seed

  threshold:
    cmd: python src\threshold.py --valid data\processed\valid.csv --model 
      models\model.joblib --out-json artifacts\best_threshold.json --metrics-out
      metrics_threshold.json --roc-out reports\roc_curve.png --pr-out 
      reports\pr_curve.png
    deps:
    - data\processed\valid.csv
    - models\model.joblib
    - src\threshold.py
    outs:
    - reports\pr_curve.png
    - reports\roc_curve.png
    metrics:
    - artifacts\best_threshold.json:
        cache: false
    - metrics_threshold.json:
        cache: false

  evaluate_test:
    cmd: python src\evaluate.py --test data\processed\test.csv --model 
      models\model.joblib --metrics-out metrics_test.json
    deps:
    - data\processed\test.csv
    - models\model.joblib
    - src\evaluate.py
    metrics:
    - metrics_test.json:
        cache: false

  tune_rf:
    cmd: python src\tune_rf.py --train data\processed\train.csv --valid 
      data\processed\valid.csv --params params.yaml --best-out 
      artifacts\best_params_rf.json --metrics-out metrics_tune_rf.json
    deps:
    - data\processed\train.csv
    - data\processed\valid.csv
    - params.yaml
    - src\tune_rf.py
    metrics:
    - artifacts\best_params_rf.json:
        cache: false
    - metrics_tune_rf.json:
        cache: false

  train_rf:
    cmd: python src\train_rf.py --train data\processed\train.csv --valid 
      data\processed\valid.csv --out-model models\model_rf.joblib --metrics 
      metrics_rf.json --best-params artifacts\best_params_rf.json --params 
      params.yaml
    deps:
    - artifacts\best_params_rf.json
    - data\processed\train.csv
    - data\processed\valid.csv
    - src\train_rf.py
    outs:
    - models\model_rf.joblib
    metrics:
    - metrics_rf.json:
        cache: false

  evaluate_test_rf:
    cmd: python src\evaluate.py --test data\processed\test.csv --model 
      models\model_rf.joblib --metrics-out metrics_test_rf.json
    deps:
    - data\processed\test.csv
    - models\model_rf.joblib
    - src\evaluate.py
    metrics:
    - metrics_test_rf.json:
        cache: false

  train_fe:
    cmd: python src\train.py --train data\features\train_fe.csv --valid 
      data\features\valid_fe.csv --out-model models\model_fe.joblib --metrics 
      metrics_fe.json --best-params artifacts\best_params.json --params 
      params.yaml
    deps:
    - artifacts\best_params.json
    - data\features\train_fe.csv
    - data\features\valid_fe.csv
    - src\train.py
    outs:
    - models\model_fe.joblib
    metrics:
    - metrics_fe.json:
        cache: false
    params:
    - train.C
    - train.max_iter
    - train.seed

  threshold_fe:
    cmd: python src\threshold.py --valid data\features\valid_fe.csv --model 
      models\model_fe.joblib --out-json artifacts\best_threshold_fe.json 
      --metrics-out metrics_threshold_fe.json --roc-out reports\roc_curve_fe.png
      --pr-out reports\pr_curve_fe.png
    deps:
    - data\features\valid_fe.csv
    - models\model_fe.joblib
    - src\threshold.py
    outs:
    - reports\pr_curve_fe.png
    - reports\roc_curve_fe.png
    metrics:
    - artifacts\best_threshold_fe.json:
        cache: false
    - metrics_threshold_fe.json:
        cache: false

  evaluate_test_fe:
    cmd: python src\evaluate.py --test data\features\test_fe.csv --model 
      models\model_fe.joblib --metrics-out metrics_test_fe.json
    deps:
    - data\features\test_fe.csv
    - models\model_fe.joblib
    - src\evaluate.py
    metrics:
    - metrics_test_fe.json:
        cache: false

  predict_test:
    cmd: python src\predict.py --input data\processed\test.csv --model 
      models\model.joblib --output predictions\preds_test.csv --threshold-file 
      artifacts\best_threshold.json
    deps:
    - src\predict.py
    - data\processed\test.csv
    - models\model.joblib
    - artifacts\best_threshold.json
    outs:
    - predictions\preds_test.csv

  predict_test_rf:
    cmd: python src\predict.py --input data\processed\test.csv --model 
      models\model_rf.joblib --output predictions\preds_test_rf.csv 
      --threshold-file artifacts\best_threshold.json
    deps:
    - src\predict.py
    - data\processed\test.csv
    - models\model_rf.joblib
    - artifacts\best_threshold.json
    outs:
    - predictions\preds_test_rf.csv

  predict_test_fe:
    cmd: python src\predict.py --input data\features\test_fe.csv --model 
      models\model_fe.joblib --output predictions\preds_test_fe.csv 
      --threshold-file artifacts\best_threshold_fe.json
    deps:
    - src\predict.py
    - data\features\test_fe.csv
    - models\model_fe.joblib
    - artifacts\best_threshold_fe.json
    outs:
    - predictions\preds_test_fe.csv

  tune_xgb:
    cmd: python src\tune_xgb.py --train data\processed\train.csv --valid 
      data\processed\valid.csv --params params.yaml --best-out 
      artifacts\best_params_xgb.json --metrics-out metrics_tune_xgb.json
    deps:
    - data\processed\train.csv
    - data\processed\valid.csv
    - params.yaml
    - src\tune_xgb.py
    metrics:
    - artifacts\best_params_xgb.json:
        cache: false
    - metrics_tune_xgb.json:
        cache: false

  train_xgb:
    cmd: python src\train_xgb.py --train data\processed\train.csv --valid 
      data\processed\valid.csv --out-model models\model_xgb.joblib --metrics 
      metrics_xgb.json --best-params artifacts\best_params_xgb.json --params 
      params.yaml
    deps:
    - artifacts\best_params_xgb.json
    - data\processed\train.csv
    - data\processed\valid.csv
    - src\train_xgb.py
    outs:
    - models\model_xgb.joblib
    metrics:
    - metrics_xgb.json:
        cache: false

  threshold_xgb:
    cmd: python src\threshold.py --valid data\processed\valid.csv --model 
      models\model_xgb.joblib --out-json artifacts\best_threshold_xgb.json 
      --metrics-out metrics_threshold_xgb.json --roc-out 
      reports\roc_curve_xgb.png --pr-out reports\pr_curve_xgb.png
    deps:
    - data\processed\valid.csv
    - models\model_xgb.joblib
    - src\threshold.py
    outs:
    - reports\pr_curve_xgb.png
    - reports\roc_curve_xgb.png
    metrics:
    - artifacts\best_threshold_xgb.json:
        cache: false
    - metrics_threshold_xgb.json:
        cache: false

  predict_test_xgb:
    cmd: python src\predict.py --input data\processed\test.csv --model 
      models\model_xgb.joblib --threshold-file artifacts\best_threshold_xgb.json
      --output predictions\preds_test_xgb.csv
    deps:
    - src\predict.py
    - data\processed\test.csv
    - models\model_xgb.joblib
    - artifacts\best_threshold_xgb.json
    outs:
    - predictions\preds_test_xgb.csv

  evaluate_test_xgb:
    cmd: python src\evaluate.py --test data\processed\test.csv --model 
      models\model_xgb.joblib --metrics-out metrics_test_xgb.json
    deps:
    - data\processed\test.csv
    - models\model_xgb.joblib
    - src\evaluate.py
    metrics:
    - metrics_test_xgb.json:
        cache: false

  select_register:
    cmd: python scripts\select_and_register.py --mlflow-uri 
      http://127.0.0.1:5001 --write-out artifacts\selection.json
    deps:
    - scripts\select_and_register.py
    - metrics_test.json
    - metrics_test_rf.json
    - metrics_test_xgb.json
    - metrics_test_fe.json
    metrics:
    - artifacts\selection.json:
        cache: false

  predict_champion:
    cmd: python scripts\predict_champion.py --test data\processed\test.csv --out
      predictions\preds_test_champion.csv --mlflow-uri http://127.0.0.1:5001
    deps:
    - scripts\predict_champion.py
    - artifacts\selection.json
    - data\processed\test.csv
    outs:
    - predictions\preds_test_champion.csv

  report_benchmark:
    cmd: python src\report_benchmark.py --sources metrics_test.json 
      metrics_test_rf.json metrics_test_xgb.json metrics_test_fe.json --out-md 
      reports/benchmark.md --out-fig reports/f1_bench.png
    deps:
    - src\report_benchmark.py
    - metrics_test.json
    - metrics_test_rf.json
    - metrics_test_xgb.json
    - metrics_test_fe.json
    outs:
    - reports\benchmark.md
    - reports\f1_bench.png

  alias_champion:
    cmd: python scripts\alias_champion.py --mlflow-uri http://127.0.0.1:5001 
      --selection artifacts\selection.json --alias champion --write-out 
      artifacts\aliases_applied.json
    deps:
    - artifacts\selection.json
    - scripts\alias_champion.py
    metrics:
    - artifacts\aliases_applied.json:
        cache: false
